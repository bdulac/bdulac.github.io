<!DOCTYPE html>
<html>
<head>
	<link href="http://gmpg.org/xfn/11" rel="profile">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<link rel="canonical" href="http://bdulac.github.io//blog/dynamic-assignation-and-proxy-objects" />
	<meta name="description" content="Still in JPA, you perhaps wonder how lazy-loading is managed. This is done via proxy objects. The Java SE platform..." />
	<meta name="author" content="Bérenger Dulac">
	<meta property="og:description" content="Still in JPA, you perhaps wonder how lazy-loading is managed. This is done via proxy objects. The Java SE platform..." />
	<meta itemprop="image" content="http://bdulac.github.io//assets/images/home.png" />
	<meta property="og:image" content="http://bdulac.github.io//assets/images/home.png" />
	<meta property="og:title" content="Dynamic assignation and proxy objects" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="http://bdulac.github.io//blog/dynamic-assignation-and-proxy-objects" />
	<meta property="og:site_name" content="Notes of a Java developer" />
	<title>Dynamic assignation and proxy objects &middot; Notes of a Java developer</title>
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" type="text/css" media="only screen and (min-width: 1001px)" href="/assets/css/desktop.css" />
	<link rel="stylesheet" type="text/css" media="only screen and (max-width: 1000px)" href="/assets/css/mobile.css" />
	<link href="/assets/css/genericons.css" type="text/css" rel="stylesheet" />
	<link href="/assets/css/syntax.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
	<link rel="apple-touch-icon" href="http://bdulac.github.io//assets/images/home.png">
	<link rel="shortcut icon" href="http://bdulac.github.io//assets/images/favicon.ico">
	<link rel="alternate" type="application/rss+xml" title="RSS" href="http://bdulac.github.io//atom.xml">
</head>
<body>
	<div id="container" style="background-image: url(/assets/images/cover.png);">
<header  style="height: 150px;">
	
	<label class="menu" for="_1">
	<span class="genericon genericon-menu"></span>
</label>
<input id="_1" type="checkbox">
<div class="menu-content">
	<div class="menu" style="background-color: #777; z-index: -1;"></div>
	
	<a href="/">Home</a><br>
	
	<a href="/about">About</a><br>
	
</div>
<div class="social-links">
	
	<a href="http://facebook.com/berenger.dulac" target="_blank" title="Join me on Facebook"><span class="genericon genericon-facebook"></span></a>
	
	<a href="https://github.com/bdulac" target="_blank" title="Fork me on github"><span class="genericon genericon-github"></span></a>
	
	<a href="http://bdulac.github.io/atom.xml" target="_blank" title="Subscribe to my Atom feed"><span class="genericon genericon-feed"></span></a>
	
	<a href="http://bdulac.github.io/feed.xml" target="_blank" title="Subscribe to my RSS feed"><span class="genericon genericon-feed"></span></a>
	
</div>
	<div id="home-title">
		<a href="http://bdulac.github.io/">
			<img src="/assets/images/home.png" class="site-icon" />
		</a>
		<h1>Notes of a Java developer</h1>
	</div>
</header>
<div id="post-list">
<!--
	<div id="post-info">
		
		<h1>Dynamic assignation and proxy objects</h1>
		
		
		<a class="site-title" href="http://bdulac.github.io/"><img src="/assets/images/home.png" class="site-icon-small">Notes of a Java developer</a>, in 23 October 2013
	</div>
	<div id="nav-icon" style="bottom: 60px;">
		<a class="scroll" data-speed="1000" href="#article"><span class="genericon genericon-expand"></span></a>
	</div>
-->
	<article>
		<header>
			<h1><a href="">Dynamic assignation and proxy objects</a></h1>
		</header>
		<main>
			<div id="article" class="post-content">
				<p>
    Still in <a href="http://en.wikipedia.org/wiki/Java_Persistence_API">JPA</a>,
    you perhaps wonder how <a
        href="http://docs.oracle.com/javaee/6/api/javax/persistence/FetchType.html#LAZY">lazy-loading</a>
    is managed. This is done via proxy objects.
</p>

<p>
    The Java SE platform provides a <a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html">proxy
        class</a> which creates proxy objects for interfaces. But this does not
    help when you wish to do the job on <a
        href="http://martinfowler.com/bliki/POJO.html">POJOs</a>.
</p>

<p>
    A framework allows to do this (and many other <a
        href="http://en.wikipedia.org/wiki/Java_bytecode">bytecode</a>
    operations) : <a href="http://www.jboss.org/javassist/">Javassist</a>.
    The <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/ProxyFactory.html">ProxyFactory</a>
    class allows to build a substitute object for any class via the <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/ProxyFactory.html#createClass%28%29">createClass</a>
    method. I guess the substitution is done by subclassing.
</p>

<p></p>

<p>
    Instances of this "dynamic" class can be created calling the <a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/Class.html#newInstance%28%29">newInstance</a>
    method. The created object implements the <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/Proxy.html">Proxy</a>
    interface. To this this interface can be associated a <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/MethodHandler.html">MethodHandler</a>
    object. Such an object is called on any access to the dynamic instance
    (including null tests). For a lazy-loading field, this is where to
    replace the dynamic instance.
</p>

<p>
    It is also recommended to specify a <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/MethodFilter.html">MethodFilter</a>
    object to the ProxyFactory to avoid the creation of proxies when
    finalizing the reference.
</p>

<p>
<pre>   ProxyFactory factory = new ProxyFactory();
    factory.setSuperclass(MyClass.class);
    factory.setFilter(
      new MethodFilter() {
        public boolean isHandled(Method m) {
            // The filter to avoid finalization
            return !m.getName().equals("finalize");
        }
      }
    );
    Class cl = factory.createClass();
    MethodHandler handler = new MethodHandler() {
        public Object invoke(
          Object self, 
          Method m, 
          Method proceed,
          Object[] args
        ) throws Throwable {
            // On each access, execution of the original operation
            return proceed.invoke(self, args);
        }
    };
    MyClass cls = (MyClass)cl.newInstance();
    ((Proxy)cls).setHandler(handler);
</pre>
</p>

<p>
    My way crossed a single problem with Javassist: null tests. While
    using dynamic objects to avoid unnecessary database access, the method
    filter proceeded the proxy replacement (database access) properly on
    null tests in most cases. But in some rare cases, the null test did not
    call the method filter and did not perform the test properly. Perhaps
    was this a misuse of the library. Anyway the workaround was to perform
    a double check (null reference test + null test on a mandatory
    property) in order to ensure the method filter call.
</p>

			</div>
		</main>
		<footer>
			<span class="post-date">23 October 2013</span>
		</footer>
	</article>
</div>
<!--

<footer class="clean">
	<div id="nav-icon" style="top: 25px;">
		<a class="scroll" data-speed="1000" href="#article"><span class="genericon genericon-collapse"></span></a>
	</div>
	<div id="post-info">
		<h3>Featured post</h3>
		<a href="/blog/history-of-computing-information-processing-and-transactions">
			<h1>History of computing: information processing and transactions</h1>
			
		</a>
	</div>
	<p class="copyright">&copy;2014, <a href="https://github.com/bdulac" target="_blank">Bérenger Dulac</a>. <a href="http://creativecommons.org/licenses/by-nc/2.5" target="_blank">Some rights reserved</a>.</p>
</footer>

-->
<footer>
	<p class="copyright">&copy;2014, <a href="https://github.com/bdulac" target="_blank">Bérenger Dulac</a>. <a href="http://creativecommons.org/licenses/by-nc/2.5" target="_blank">Some rights reserved</a>.</p>
</footer>
</div>
<script src="/assets/js/smooth-scroll.js"></script>
</body>
</html>