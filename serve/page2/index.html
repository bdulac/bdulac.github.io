<!DOCTYPE html>
<html>
<head>
	<link href="http://gmpg.org/xfn/11" rel="profile">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<title>Notes of a Java developer &middot; blog</title>
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="HandheldFriendly" content="True" />
	<meta name="MobileOptimized" content="320" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<link rel="stylesheet" type="text/css" media="only screen and (min-width: 1001px)" href="/assets/css/desktop.css" />
	<link rel="stylesheet" type="text/css" media="only screen and (max-width: 1000px)" href="/assets/css/mobile.css" />
	<link href="/assets/css/genericons.css" type="text/css" rel="stylesheet" />
	<link href="/assets/css/syntax.css" type="text/css" rel="stylesheet" />
	<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
	<link rel="apple-touch-icon" href="http://bdulac.github.io//assets/images/home.png">
	<link rel="shortcut icon" href="http://bdulac.github.io//assets/images/favicon.ico">
	<link rel="alternate" type="application/rss+xml" title="RSS" href="http://bdulac.github.io//atom.xml">
</head>
<body>
	<div id="container" style="background-image: url(/assets/images/cover.png);">
<header style="height: 150px;">
	<label class="menu" for="_1">
	<span class="genericon genericon-menu"></span>
</label>
<input id="_1" type="checkbox">
<div class="menu-content">
	<div class="menu" style="background-color: #777; z-index: -1;"></div>
	
	<a href="/">Home</a><br>
	
	<a href="/about">About</a><br>
	
</div>
<div class="social-links">
	
	<a href="http://facebook.com/berenger.dulac" target="_blank" title="Join me on Facebook"><span class="genericon genericon-facebook"></span></a>
	
	<a href="https://github.com/bdulac" target="_blank" title="Fork me on github"><span class="genericon genericon-github"></span></a>
	
	<a href="http://bdulac.github.io/atom.xml" target="_blank" title="Subscribe to my Atom feed"><span class="genericon genericon-feed"></span></a>
	
	<a href="http://bdulac.github.io/feed.xml" target="_blank" title="Subscribe to my RSS feed"><span class="genericon genericon-feed"></span></a>
	
</div>
	<div id="home-title">
		<a href="http://bdulac.github.io/">
			<img src="/assets/images/home.png" class="site-icon" />
		</a>
		<h1>Notes of a Java developer</h1>
	</div>
</header>
<div id="post-list">
	
	<article>
		<header>
			<h1><a href="/blog/references-caching-and-garbage-collection">References, caching and garbage collection</a></h1>
		</header>
		<main>
			<div id="article" class="post-content">
				<p>For a long time I have been wondering how do frameworks manage
    memory while caching.</p>
<p>
    The <a href="http://www.eclipse.org/eclipselink/">EclipseLink</a>
    documentation <a
        href="http://wiki.eclipse.org/EclipseLink/UserGuide/JPA/Basic_JPA_Development/Caching/Type_and_Size">gave
        me the answer</a>. The Java SE platform provide special references :
<ul>
    <li><a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/ref/SoftReference.html">Soft
            references</a></li>
    <li><a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/ref/WeakReference.html">Weak
            references</a></li>
    <li><a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/ref/PhantomReference.html">Phantom
            references</a></li>
</ul>
According to the official documentation, soft references are used to
provide memory-sensitive properties to cached references. This can be
very efficient.
</p>

<p>But access to soft-referenced objects needs to be done via
    specific objects so that freed references can be renewed (e.g. via a
    persistent storage).</p>
<p>
    The official API also provides a special <a
        href="http://docs.oracle.com/javase/7/docs/api/java/util/WeakHashMap.html">map
        with weak referenced keys</a>. This class can be useful but is not really
    appropriate for caching as keys are released.
</p>

			</div>
		</main>
		<!-- <p class="post-description">For a long time I have been wondering how do frameworks manage
    memory while caching.

    The EclipseLink
    documentation gave
        me the answer. The Java SE platform provide special references :

    Soft
            references
    Weak
            references
    Phantom
            references

According to the official documentation, soft references are used to
provide memory-sensitive properties to cached references. This can be
very efficient.


But access to soft-referenced objects needs to be done via
    specific objects so that freed references can be renewed (e.g. via a
    persistent storage).

    The official API also provides a special map
        with weak referenced keys. This class can be useful but is not really
    appropriate for caching as keys are released.

</p> -->
		<footer>
			<span class="post-date">23 October 2013</span>
		</footer>
	</article>
		<br>
	
	<article>
		<header>
			<h1><a href="/blog/dynamic-assignation-and-proxy-objects">Dynamic assignation and proxy objects</a></h1>
		</header>
		<main>
			<div id="article" class="post-content">
				<p>
    Still in <a href="http://en.wikipedia.org/wiki/Java_Persistence_API">JPA</a>,
    you perhaps wonder how <a
        href="http://docs.oracle.com/javaee/6/api/javax/persistence/FetchType.html#LAZY">lazy-loading</a>
    is managed. This is done via proxy objects.
</p>

<p>
    The Java SE platform provides a <a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/reflect/Proxy.html">proxy
        class</a> which creates proxy objects for interfaces. But this does not
    help when you wish to do the job on <a
        href="http://martinfowler.com/bliki/POJO.html">POJOs</a>.
</p>

<p>
    A framework allows to do this (and many other <a
        href="http://en.wikipedia.org/wiki/Java_bytecode">bytecode</a>
    operations) : <a href="http://www.jboss.org/javassist/">Javassist</a>.
    The <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/ProxyFactory.html">ProxyFactory</a>
    class allows to build a substitute object for any class via the <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/ProxyFactory.html#createClass%28%29">createClass</a>
    method. I guess the substitution is done by subclassing.
</p>

<p></p>

<p>
    Instances of this "dynamic" class can be created calling the <a
        href="http://docs.oracle.com/javase/7/docs/api/java/lang/Class.html#newInstance%28%29">newInstance</a>
    method. The created object implements the <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/Proxy.html">Proxy</a>
    interface. To this this interface can be associated a <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/MethodHandler.html">MethodHandler</a>
    object. Such an object is called on any access to the dynamic instance
    (including null tests). For a lazy-loading field, this is where to
    replace the dynamic instance.
</p>

<p>
    It is also recommended to specify a <a
        href="http://www.csg.ci.i.u-tokyo.ac.jp/~chiba/javassist/html/javassist/util/proxy/MethodFilter.html">MethodFilter</a>
    object to the ProxyFactory to avoid the creation of proxies when
    finalizing the reference.
</p>

<p>
<pre>   ProxyFactory factory = new ProxyFactory();
    factory.setSuperclass(MyClass.class);
    factory.setFilter(
      new MethodFilter() {
        public boolean isHandled(Method m) {
            // The filter to avoid finalization
            return !m.getName().equals("finalize");
        }
      }
    );
    Class cl = factory.createClass();
    MethodHandler handler = new MethodHandler() {
        public Object invoke(
          Object self, 
          Method m, 
          Method proceed,
          Object[] args
        ) throws Throwable {
            // On each access, execution of the original operation
            return proceed.invoke(self, args);
        }
    };
    MyClass cls = (MyClass)cl.newInstance();
    ((Proxy)cls).setHandler(handler);
</pre>
</p>

<p>
    My way crossed a single problem with Javassist: null tests. While
    using dynamic objects to avoid unnecessary database access, the method
    filter proceeded the proxy replacement (database access) properly on
    null tests in most cases. But in some rare cases, the null test did not
    call the method filter and did not perform the test properly. Perhaps
    was this a misuse of the library. Anyway the workaround was to perform
    a double check (null reference test + null test on a mandatory
    property) in order to ensure the method filter call.
</p>

			</div>
		</main>
		<!-- <p class="post-description">
    Still in JPA,
    you perhaps wonder how lazy-loading
    is managed. This is done via proxy objects.



    The Java SE platform provides a proxy
        class which creates proxy objects for interfaces. But this does not
    help when you wish to do the job on POJOs.



    A framework allows to do this (and many other bytecode
    operations) : Javassist.
    The ProxyFactory
    class allows to build a substitute object for any class via the createClass
    method. I guess the substitution is done by subclassing.





    Instances of this "dynamic" class can be created calling the newInstance
    method. The created object implements the Proxy
    interface. To this this interface can be associated a MethodHandler
    object. Such an object is called on any access to the dynamic instance
    (including null tests). For a lazy-loading field, this is where to
    replace the dynamic instance.



    It is also recommended to specify a MethodFilter
    object to the ProxyFactory to avoid the creation of proxies when
    finalizing the reference.



   ProxyFactory factory = new ProxyFactory();
    factory.setSuperclass(MyClass.class);
    factory.setFilter(
      new MethodFilter() {
        public boolean isHandled(Method m) {
            // The filter to avoid finalization
            return !m.getName().equals("finalize");
        }
      }
    );
    Class cl = factory.createClass();
    MethodHandler handler = new MethodHandler() {
        public Object invoke(
          Object self, 
          Method m, 
          Method proceed,
          Object[] args
        ) throws Throwable {
            // On each access, execution of the original operation
            return proceed.invoke(self, args);
        }
    };
    MyClass cls = (MyClass)cl.newInstance();
    ((Proxy)cls).setHandler(handler);




    My way crossed a single problem with Javassist: null tests. While
    using dynamic objects to avoid unnecessary database access, the method
    filter proceeded the proxy replacement (database access) properly on
    null tests in most cases. But in some rare cases, the null test did not
    call the method filter and did not perform the test properly. Perhaps
    was this a misuse of the library. Anyway the workaround was to perform
    a double check (null reference test + null test on a mandatory
    property) in order to ensure the method filter call.

</p> -->
		<footer>
			<span class="post-date">23 October 2013</span>
		</footer>
	</article>
		<br>
	
	<article>
		<header>
			<h1><a href="/blog/point-of-view-packaging">Point of view: Packaging</a></h1>
		</header>
		<main>
			<div id="article" class="post-content">
				<p>
    According to the <a href="http://www.worldcat.org/oclc/39516151">UML
        user guide</a>, object-oriented software elements belong to four
    categories :
</p>

<p>
<ul>
    <li>Structural things</li>
    <li>Behavioral things</li>
    <li>Grouping things</li>
    <li>Notational things</li>
</ul>
Obviously, classes are structural elements.
</p>

<p>
    According to this same book, <a
        href="http://en.wikipedia.org/wiki/Package_%28UML%29">packaging</a> is
    the act of grouping classes.
</p>

<p>Something is bothering me about packaging. All programs I have
    been working on, and all courses I have been following, share a single
    vision of the way these groups should be considered.</p>
<p>
    In this single vision, classes are grouped on structural criteria. In a
    same package, we will find objects assuming a single role. This helps
    designing interesting <a
        href="http://en.wikipedia.org/wiki/Class_diagram">class</a> diagrams.
    To be honest, this has a real interest to build effective heritage
    hierarchies.
</p>

<p>
    But in my point of view, we let apart behavioral criteria. This means,
    if we design <a href="http://en.wikipedia.org/wiki/Sequence_diagram">sequence</a>,
    <a href="http://en.wikipedia.org/wiki/Activity_diagram">activity</a> or
    <a href="http://en.wikipedia.org/wiki/State_diagram_%28UML%29">state</a>
    diagrams, the involved objects will belong to different packages.
</p>

<p>If we would like to design really modular applications, I think
    we should consider these two axes in packaging. On a pure design point
    of view, a class should belong to two packages : one structural and one
    behavioral. This could be possible because one class usually has
    interactions with a few classes.</p>
<p>
    In Java, one solution to help set up this second kind of packages could
    be annotations. But the problem would be in class loading. This
    wouldn't be a real problem if we all time use to <a
        href="http://dx.doi.org/10.1145/1176617.1176622">write APIs</a>.
</p>

			</div>
		</main>
		<!-- <p class="post-description">
    According to the UML
        user guide, object-oriented software elements belong to four
    categories :




    Structural things
    Behavioral things
    Grouping things
    Notational things

Obviously, classes are structural elements.



    According to this same book, packaging is
    the act of grouping classes.


Something is bothering me about packaging. All programs I have
    been working on, and all courses I have been following, share a single
    vision of the way these groups should be considered.

    In this single vision, classes are grouped on structural criteria. In a
    same package, we will find objects assuming a single role. This helps
    designing interesting class diagrams.
    To be honest, this has a real interest to build effective heritage
    hierarchies.



    But in my point of view, we let apart behavioral criteria. This means,
    if we design sequence,
    activity or
    state
    diagrams, the involved objects will belong to different packages.


If we would like to design really modular applications, I think
    we should consider these two axes in packaging. On a pure design point
    of view, a class should belong to two packages : one structural and one
    behavioral. This could be possible because one class usually has
    interactions with a few classes.

    In Java, one solution to help set up this second kind of packages could
    be annotations. But the problem would be in class loading. This
    wouldn't be a real problem if we all time use to write APIs.

</p> -->
		<footer>
			<span class="post-date">19 October 2013</span>
		</footer>
	</article>
		<br>
	
	<article>
		<header>
			<h1><a href="/blog/heisenbug-concurrency-case">Heisenbug - Concurrency case</a></h1>
		</header>
		<main>
			<div id="article" class="post-content">
				<p>
    Solving an <a href="http://en.wikipedia.org/wiki/Debugger">Heisenbug</a>
    can be really tricky. This kind of bugs occur when the program
    execution conditions are changing. In many cases, using a <a
        href="http://en.wikipedia.org/wiki/Debugger">debugger</a> or a log
    output doesn't help. Such tools can have an influence on the execution.
</p>

<p>
    I once faced such a bug in a <a
        href="http://en.wikipedia.org/wiki/Java_Swing">Swing</a> application.
    The problem occurred in a quite long process (half an hour)&nbsp; at
    various steps with constant input data. I lost time with that bug
    because I had no methodology. I have to admit the solution is really
    simple.
</p>

<p>
    I simply designed an <a
        href="http://en.wikipedia.org/wiki/Activity_diagram">activity
        diagram</a> of the main activities of the process. I paid attention to
    swimlanes because I suspected a concurrency problem. For each activity
    there was a single log output. A custom logging level was set up so
    that only activity logs could be written (an attempt with the debug
    level logs was completely helpless). The logging framework was also
    configured to print the current thread name. There I got the activity
    which was not in the right place and the name of the criminal. The
    random occurrence of the problem was probably due to the system load
    and user interactions.
</p>

			</div>
		</main>
		<!-- <p class="post-description">
    Solving an Heisenbug
    can be really tricky. This kind of bugs occur when the program
    execution conditions are changing. In many cases, using a debugger or a log
    output doesn't help. Such tools can have an influence on the execution.



    I once faced such a bug in a Swing application.
    The problem occurred in a quite long process (half an hour)&nbsp; at
    various steps with constant input data. I lost time with that bug
    because I had no methodology. I have to admit the solution is really
    simple.



    I simply designed an activity
        diagram of the main activities of the process. I paid attention to
    swimlanes because I suspected a concurrency problem. For each activity
    there was a single log output. A custom logging level was set up so
    that only activity logs could be written (an attempt with the debug
    level logs was completely helpless). The logging framework was also
    configured to print the current thread name. There I got the activity
    which was not in the right place and the name of the criminal. The
    random occurrence of the problem was probably due to the system load
    and user interactions.

</p> -->
		<footer>
			<span class="post-date">18 October 2013</span>
		</footer>
	</article>
		<br>
	
	<article>
		<header>
			<h1><a href="/blog/spi">SPI</a></h1>
		</header>
		<main>
			<div id="article" class="post-content">
				<p>
What are the
    <a href="http://en.wikipedia.org/wiki/Service_provider_interface">Service
        Provider Interfaces</a> (SPI) ?
</p>

<p>
    These are important elements of the Java platform. More documentation is
    available in the <a
        href="http://docs.oracle.com/javase/tutorial/sound/SPI-intro.html">official
        tutorial</a>. In a few words, you probably have noticed the Java APIs
    mainly consist in interfaces. The SPI is the mechanism setting up the
    appropriate implementation so that programs don't rely on the
    implementation at compile time.
</p>

<p>
    When an implementation is provided, to associate it to the implemented
    interface, there is one (or more) entry point. For example, the <a
        href="http://en.wikipedia.org/wiki/Java_Persistence_API">JPA</a> API
    has for single point the interface <a
        href="http://docs.oracle.com/javaee/6/api/javax/persistence/spi/PersistenceProvider.html">javax.persistence.spi.PersistenceProvider</a>
    . All other interfaces are available via this one.
</p>

<p>
    If you want to provide a JPA implementation, you first have to code a
    class implementing this interface. Then, a text file named after the
    fully qualified name of the interface should be available to the class
    loader setting up the environment in the <i>META-INF/services</i>
    directory. <br /> This mean, if you are working with <a
        href="http://www.eclipse.org/">Eclipse</a> IDE in a Java SE
    environment with an <i>src</i> source directory : <br />
    <code>src/META-INF/services/javax.persistence.spi.PersistenceProvider</code>
</p>

<p>
    This text file just has to contain the available implementations. If I
    want my own implementation (the provider is
    org.test.jpaimpl.PersistenceProvider) to be available along with <a
        href="http://www.eclipse.org/eclipselink/">EclipseLink</a> (the
    provider is <a
        href="http://www.eclipse.org/eclipselink/api/2.3/org/eclipse/persistence/jpa/PersistenceProvider.html">org.eclipse.persistence.jpa.PersistenceProvider</a>
    ) the file has to contain these two lines :&nbsp;
    <code></code>
</p>

<p>
    <code>org.eclipse.persistence.jpa.PersistenceProvider
        org.test.jpaimpl.PersistenceProvider</code>
</p>

<p>
    For the specific case of JPA, when multiple implementations are found
    by the class loader, the implementation to use can be specified in the
    <i>persistence.xml</i> file, in the <i>provider</i> element of a <i>persistence-unit</i>
    :
<p>
<pre>
    <br /> &lt;persistence version="2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/persistence" xsi:schemalocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;<br />  &lt;persistence-unit name="COLLECTIONS" transaction-type="RESOURCE_LOCAL"&gt;<br />       &lt;provider>org.test.jpaimpl.PersistenceProvider&lt;/provider&gt;<br />       ...<br />  &lt;/persistence-unit&gt;<br />&lt;/persistence&gt;<br />
</pre>
</p>

			</div>
		</main>
		<!-- <p class="post-description">
What are the
    Service
        Provider Interfaces (SPI) ?



    These are important elements of the Java platform. More documentation is
    available in the official
        tutorial. In a few words, you probably have noticed the Java APIs
    mainly consist in interfaces. The SPI is the mechanism setting up the
    appropriate implementation so that programs don't rely on the
    implementation at compile time.



    When an implementation is provided, to associate it to the implemented
    interface, there is one (or more) entry point. For example, the JPA API
    has for single point the interface javax.persistence.spi.PersistenceProvider
    . All other interfaces are available via this one.



    If you want to provide a JPA implementation, you first have to code a
    class implementing this interface. Then, a text file named after the
    fully qualified name of the interface should be available to the class
    loader setting up the environment in the META-INF/services
    directory.  This mean, if you are working with Eclipse IDE in a Java SE
    environment with an src source directory : 
    src/META-INF/services/javax.persistence.spi.PersistenceProvider



    This text file just has to contain the available implementations. If I
    want my own implementation (the provider is
    org.test.jpaimpl.PersistenceProvider) to be available along with EclipseLink (the
    provider is org.eclipse.persistence.jpa.PersistenceProvider
    ) the file has to contain these two lines :&nbsp;
    



    org.eclipse.persistence.jpa.PersistenceProvider
        org.test.jpaimpl.PersistenceProvider



    For the specific case of JPA, when multiple implementations are found
    by the class loader, the implementation to use can be specified in the
    persistence.xml file, in the provider element of a persistence-unit
    :


     &lt;persistence version="2.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/persistence" xsi:schemalocation="http://java.sun.com/xml/ns/persistence http://java.sun.com/xml/ns/persistence/persistence_2_0.xsd"&gt;  &lt;persistence-unit name="COLLECTIONS" transaction-type="RESOURCE_LOCAL"&gt;       &lt;provider>org.test.jpaimpl.PersistenceProvider&lt;/provider&gt;       ...  &lt;/persistence-unit&gt;&lt;/persistence&gt;


</p> -->
		<footer>
			<span class="post-date">16 October 2013</span>
		</footer>
	</article>
		<br>
	
</div>
<nav class="pagination" role="navigation">
	
	<span class="page-number">Page 2 of 2</span>
	
		
			<a class="older-posts" href="/">Newer posts &rarr;</a>
		
	
</nav>
<footer class="clean" style="background-image: url(/assets/images/cover.png); background-position: bottom; height: 60px;">
	<p class="copyright">&copy;2014, <a href="https://github.com/bdulac" target="_blank">Bérenger Dulac</a>. <a href="http://creativecommons.org/licenses/by-nc/2.5" target="_blank">Some rights reserved</a>.</p>
</footer>
</div>
</body>
</html>